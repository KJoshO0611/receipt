<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Filler</title>
  <style>
    :root {
      --page-w: 794px;   /* A4 width @96dpi approx */
      --page-h: 1123px;  /* A4 height @96dpi approx */
      --ink: #222;
      --accent: #6b5b95;
    }

    body {
      font-family: "Helvetica Neue", Arial, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Liberation Sans", sans-serif;
      margin: 0;
      background: #f4f5f7;
      color: var(--ink);
    }

    /* Toolbar (not printed) */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      gap: .75rem;
      align-items: center;
      padding: .75rem 1rem;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
    }
    .toolbar input[type="file"] { max-width: 280px; }
    .toolbar button {
      padding: .55rem .9rem;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: .45rem;
      cursor: pointer;
    }
    .toolbar button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .hint { color: #6b7280; font-size: .9rem; }

    /* Page */
    .page-wrap { display: grid; place-items: center; padding: 18px; }
    .pages { display: grid; gap: 18px; }

    :root { --scale: 1; }
    .quarter { --scale: 0.5; }

    .page {
      position: relative;
      width: calc(var(--page-w) * var(--scale));
      height: calc(var(--page-h) * var(--scale));
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      background: #fff;
      overflow: hidden;
    }

    .content { position: absolute; inset: 0; width: var(--page-w); height: var(--page-h); transform: scale(var(--scale)); transform-origin: top left; }

    /* Static receipt design container */
    .bg {
      position: absolute;
      inset: 0;
      background: #fff;
      font-size: 14px;
      color: #111827;
      user-select: none;
    }

    /* Static elements */
    .design { position: absolute; inset: 0; }
    .bar-top { position: absolute; left: 0; right: 0; top: 32px; height: 72px; background: #0b0b0d; color: #fff; display: grid; place-items: center; text-align: center; }
    .bar-top > div { width: 100%; text-align: center; }
    .bar-top .title, .bar-top .sub { margin-left: auto; margin-right: auto; }
    .bar-top .title { font-family: "Oswald", Arial, sans-serif; letter-spacing: 2px; font-size: 28px; }
    .bar-top .sub { margin-top: -6px; font-size: 14px; opacity: .9; }

    .section-title { position: absolute; left: 20px; font-weight: 700; font-size: 18px; }
    .payor-title { top: 124px; }
    .receiver-title { bottom: 210px; }

    .label { position: absolute; left: 20px; color: #9ca3af; }
    .l-payor-name { top: 188px; }
    .l-payor-date { top: 218px; }
    .l-payor-sign { top: 246px; }
    .l-recv-name  { bottom: 182px; }
    .l-recv-date  { bottom: 152px; }
    .l-recv-sign  { bottom: 124px; }

    /* Table header and box */
    .table-head { position: absolute; left: 0; right: 0; top: 304px; height: 28px; background: #0b0b0d; color: #fff; font-weight: 600; display: grid; grid-template-columns: 1fr 200px; padding: 0 18px 0 18px; align-items: center; }
    .table-box { position: absolute; left: 18px; right: 18px; top: 332px; bottom: 360px; border: 2px solid #0b0b0d; border-top: none; }
    .table-div { position: absolute; top: 332px; bottom: 360px; right: 220px; width: 0; border-right: 2px solid #0b0b0d; }

    /* Total label area */
    .total-label { position: absolute; right: 260px; bottom: 300px; color: #5b21b6; font-weight: 700; }

    /* Editable fields overlay */
    .overlay { position: absolute; inset: 0; }
    .field {
      position: absolute;
      min-width: 120px;
      min-height: 20px;
      padding: 2px 4px;
      line-height: 1.2;
      color: #111827;
      background: transparent;
      border: 1px dashed rgba(107,114,128,.6);
      border-radius: 4px;
      box-sizing: border-box;
    }
    .field[contenteditable="true"]:empty:before { content: attr(data-ph); color: #9ca3af; }

    /* Monetary right-aligned */
    .money { text-align: right; min-width: 140px; }

    /* Signature images */
    .sig { position: absolute; width: 180px; height: 48px; pointer-events: none; }
    .sig img { width: 100%; height: 100%; object-fit: contain; }

    /* Placement tuned to the sample image */
    /* Header title is part of the image; fields start under it */
    .payor-name { left: 120px; top: 185px; width: 300px; }
    .payor-date { left: 120px; top: 215px; width: 220px; }
    .payor-sig  { left: 120px; top: 243px; }

    /* Items table area (covers the table between the black headers and total) */
    .items {
      position: absolute;
      left: 18px;
      right: 40px; /* keeps subtotal aligned to the right margin used elsewhere */
      top: 332px;  /* first row aligns just beneath the table header in the image */
      bottom: 360px; /* leaves room above the printed total bar */
      padding-right: 0;
      pointer-events: none; /* container shouldn't capture clicks */
    }
    .rows {
      position: absolute; inset: 0;
      display: grid;
      grid-template-columns: 1fr 180px; /* description | subtotal column width */
      grid-auto-rows: 28px; /* approx line height matching the printed ruling */
      align-content: start;
      gap: 6px 16px; /* vertical | horizontal */
      pointer-events: auto; /* allow editing inside */
    }
    .row { display: contents; }
    .cell {
      position: relative;
      border: 1px dashed rgba(107,114,128,.6);
      border-radius: 4px;
      padding: 2px 4px;
      min-height: 24px;
    }
    .cell[contenteditable="true"]:empty:before { content: attr(data-ph); color: #9ca3af; }
    .cell.amount { text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 6px; padding-right: 6px; }
    .cell.amount .prefix { user-select: none; color: #111827; }
    .cell.amount .value { min-width: 80px; border-bottom: 1px dashed rgba(107,114,128,.4); }

    /* Description dropdown/input styling */
    .cell.desc { padding: 0 4px; display: flex; align-items: center; position: relative; }
    .cell.desc input.desc-input,
    .cell.desc select.desc-select {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      font: inherit;
      padding: 2px 0;
    }
    /* Proper dropdown styling */
    .cell.desc select.desc-select {
      -webkit-appearance: none;
      appearance: none;
      padding-right: 22px; /* space for arrow */
      line-height: 1.4;
      height: 26px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 4px center;
      background-size: 14px;
      cursor: default;
    }
    .cell.desc select.desc-select:focus {
      outline: 2px solid rgba(99,102,241,.35);
      outline-offset: 1px;
      border-radius: 4px;
    }
    /* Toggle button to go back to the list when custom input is active */
    .cell.desc .desc-toggle {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
      padding: 0 2px;
      line-height: 1;
      display: none; /* shown only when custom input is active */
    }
    .cell.desc .desc-toggle:hover { color: #374151; }

    /* Clean capture mode */
    .exporting .field,
    .exporting .cell { border-color: transparent !important; }
    .exporting .cell.amount .value { border-color: transparent !important; }
    .exporting .field:focus { outline: none !important; }
    .exporting .field[contenteditable="true"]:empty:before,
    .exporting .cell[contenteditable="true"]:empty:before { content: '' !important; }

    .total      { right: 40px; bottom: 300px; width: 200px; color: #5b21b6; font-weight: 700; }

    .recv-name  { left: 120px; bottom: 178px; width: 320px; }
    .recv-date  { left: 120px; bottom: 148px; width: 220px; } 
    .recv-sig   { left: 120px; bottom: 120px; }

    .receipt-no { right: 40px; bottom: 128px; width: 200px; text-align: right; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Date input appearance */
    .field.date {
      padding: 4px 4px; /* remove extra right padding that created a dead zone */
      height: 30px;
      line-height: 30px; /* center text vertically */
      display: inline-flex;
      align-items: center;
      background: transparent;
      color: #111827;
      cursor: pointer !important;            /* whole field is a hit box */
      font: inherit;                /* match font of other fields */
      -webkit-appearance: none;     /* normalize rendering */
      appearance: none;
      text-align: left;
    }
    /* Make the calendar icon easier to click */
    .field.date::-webkit-calendar-picker-indicator {
      /* Let the input control hover/click so cursor stays consistent */
      pointer-events: none;
      display: inline-block;
      width: 20px;
      height: 20px;
      padding: 0;
      margin: 3px 0 0 6px;
      -webkit-appearance: none;
      appearance: none;
    }
    .field.date::-webkit-datetime-edit { padding: 0; }
    .field.date::-webkit-datetime-edit-fields-wrapper { padding: 0; margin: 0; }
    .field.date::-webkit-datetime-edit-month-field,
    .field.date::-webkit-datetime-edit-day-field,
    .field.date::-webkit-datetime-edit-year-field,
    .field.date::-webkit-datetime-edit-text { padding: 0; margin: 0; }
    .field.date { text-indent: 0; }
    .field.date:focus { outline: 2px solid rgba(99,102,241,.35); outline-offset: 2px; }

    /* Print styles */
    @media print {
      @page { size: A4; margin: 6mm; }
      body { background: #fff; }
      .toolbar { display: none !important; }
      .page-wrap { padding: 0; }
      .pages { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 4mm 6mm; justify-content: center; align-content: start; }
      .page { box-shadow: none; margin: 0; page-break-inside: avoid; break-inside: avoid; width: calc(var(--page-w) * var(--scale)); height: calc(var(--page-h) * var(--scale)); transform: none; }
      .content { transform: scale(var(--scale)); transform-origin: top left; }
      .bg, .overlay { page-break-inside: avoid; break-inside: avoid; }
      .field { border-color: transparent; }

      /* Hide empty editable fields */
      .field[contenteditable="true"]:empty { display: none !important; }

      /* Hide empty description inputs (uses placeholder to detect emptiness) */
      .cell.desc input.desc-input:placeholder-shown { display: none !important; }

      /* Hide empty amount values */
      .cell.amount .value:empty { display: none !important; }

      /* Hide the date picker icon in print and hide empty dates */
      .field.date::-webkit-calendar-picker-indicator { display: none !important; }
      .field.date[value=""] { display: none !important; }
      .field.date:invalid { display: none !important; }
      /* Hide empty description selects */
      .cell.desc select.desc-select:invalid { display: none !important; }

      /* Force colors to print */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .bar-top { background: #0b0b0d !important; color: #ffffff !important; }
      .table-head { background: #0b0b0d !important; color: #ffffff !important; }
      .table-box, .table-div { border-color: #0b0b0d !important; }
      .total-label { color: #5b21b6 !important; }

      /* Quarter mode: slightly larger in print */
      .quarter { --scale: 0.65; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <label>
      Payor signature:
      <input id="sigPayorPicker" type="file" accept="image/*" />
    </label>
    <label>
      Receiver signature:
      <input id="sigRecvPicker" type="file" accept="image/*" />
    </label>
    <label>
      <input id="autoTotal" type="checkbox" checked /> Auto‑sum total
    </label>
    <label>
      <input id="quarterToggle" type="checkbox" /> Quarter A4 mode
    </label>
    <button id="addReceipt" type="button">Add receipt</button>
    <button id="saveImages" type="button">Save as image(s)</button>
    <button id="addLine" type="button">Add line</button>
    <button id="removeLine" type="button">Remove last</button>
    <button class="primary" onclick="window.print()">Print</button>
    <span class="hint">Tip: click any field to edit. Guides won’t print.</span>
  </div>

  <div class="page-wrap">
    <div class="pages" id="pages">
      <div class="page">
        <div class="content">
      <div class="bg">
        <div class="design">
          <div class="bar-top">
            <div>
              <div class="title" contenteditable="true">JIISA</div>
              <div class="sub" contenteditable="true">Receipt</div>
            </div>
          </div>

          <div class="section-title payor-title">Payor's Information</div>
          <div class="label l-payor-name">Name:</div>
          <div class="label l-payor-date">Date:</div>
          <div class="label l-payor-sign">Signature:</div>

          <div class="table-head">
            <div>Description</div>
            <div style="text-align:right; padding-right:22px">Subtotal</div>
          </div>
          <div class="table-box"></div>
          <div class="table-div"></div>

          <div class="total-label">Total:</div>

          <div class="section-title receiver-title">Receiver's Information:</div>
          <div class="label l-recv-name">Name:</div>
          <div class="label l-recv-date">Date:</div>
          <div class="label l-recv-sign">Signature:</div>
        </div>
      </div>

      <div class="overlay">
        <!-- Payor info -->
        <div class="field payor-name" contenteditable="true" data-ph="Jeffrey T. Tillo"></div>
        <input class="field date payor-date" type="date" />
        <div class="sig payor-sig" id="sigPayor"></div>

        <!-- Items (dynamic rows) -->
        <div class="items">
          <div class="rows" id="rows"></div>
        </div>

        <!-- Total -->
        <div id="totalField" class="field money total">
          <span class="prefix">PHP</span>
          <span class="value" contenteditable="true" data-ph="255.00"></span>
        </div>

        <!-- Receiver info -->
        <div class="field recv-name" contenteditable="true" data-ph="Sebastian Axl G. Ortua"></div>
        <input class="field date recv-date" type="date" />
        <div class="sig recv-sig" id="sigRecv"></div>

        <!-- Receipt number -->
        <div class="field receipt-no" contenteditable="true" data-ph="PR-OTS-0009"></div>
      </div>
        </div>
      </div>
    </div>
  </div>

  <!-- html2canvas for exporting to images -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // Helper to read image files as data URLs (used for signatures)
    function loadImageFile(input, cb) {
      const file = input.files && input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => cb(reader.result);
      reader.readAsDataURL(file);
    }

    function connectSignature(pickerId, targetId) {
      const picker = document.getElementById(pickerId);
      const target = document.getElementById(targetId);
      picker.addEventListener('change', () => {
        loadImageFile(picker, (src) => {
          target.innerHTML = '';
          const img = document.createElement('img');
          img.src = src;
          img.alt = 'Signature';
          target.appendChild(img);
        });
      });
    }

    // Export each receipt (.page > .content) as an individual PNG
    async function savePageAsImage(contentEl, index) {
      // Temporarily remove scaling for crisp capture
      const prevTransform = contentEl.style.transform;
      contentEl.style.transform = 'none';
      contentEl.classList.add('exporting');
      try {
        const canvas = await html2canvas(contentEl, {
          backgroundColor: '#ffffff',
          useCORS: true,
          scale: Math.max(2, window.devicePixelRatio),
          logging: false,
        });
        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `receipt-${index}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } finally {
        contentEl.style.transform = prevTransform;
        contentEl.classList.remove('exporting');
      }
    }

    // (listener moved below after variable declarations)

    // Signature upload applies to the first receipt for now
    connectSignature('sigPayorPicker', 'sigPayor');
    connectSignature('sigRecvPicker', 'sigRecv');

    // Items dynamic rows
    const rowsEl = document.getElementById('rows');
    const addBtn = document.getElementById('addLine');
    const removeBtn = document.getElementById('removeLine');
    const autoTotal = document.getElementById('autoTotal');
    const totalField = document.getElementById('totalField');
    const quarterToggle = document.getElementById('quarterToggle');
    const addReceiptBtn = document.getElementById('addReceipt');
    const saveImagesBtn = document.getElementById('saveImages');
    const pagesWrap = document.getElementById('pages');

    function addRow(desc = '', amt = '') {
      const row = document.createElement('div');
      row.className = 'row';

      const d = document.createElement('div');
      d.className = 'cell desc';
      // Proper dropdown select (kept in DOM)
      const sel = document.createElement('select');
      sel.className = 'desc-select';
      sel.required = true; // lets us hide empty selects in print via :invalid
      // Placeholder option
      const optPlaceholder = new Option('Description', '', true, false);
      optPlaceholder.disabled = true;
      sel.appendChild(optPlaceholder);
      // Options from data
      const ensureOptions = () => {
        descOptionsData.forEach(txt => sel.appendChild(new Option(txt, txt)));
        // Custom option
        sel.appendChild(new Option('Custom…', '__custom__'));
      };
      ensureOptions();
      // If prefilled desc not in list, add it
      if (desc) {
        const inList = descOptionsData.includes(desc);
        if (!inList) sel.appendChild(new Option(desc, desc));
        sel.value = inList ? desc : desc;
      }
      // Custom input (hidden by default)
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'desc-input';
      inp.placeholder = 'Enter description';
      inp.style.display = 'none';

      // Toggle button to return to list
      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'desc-toggle';
      toggle.title = 'Choose from list';
      toggle.textContent = '▼';
      toggle.addEventListener('click', () => switchToSelect());

      d.appendChild(sel);
      d.appendChild(inp);
      d.appendChild(toggle);

      function switchToInput() {
        sel.style.display = 'none';
        inp.style.display = '';
        toggle.style.display = '';
        inp.focus();
        inp.select();
      }
      function switchToSelect() {
        sel.style.display = '';
        inp.style.display = 'none';
        toggle.style.display = 'none';
        // If custom text exists, add it to list for later reuse
        if (inp.value && !Array.from(sel.options).some(o => o.value === inp.value)) {
          sel.insertBefore(new Option(inp.value, inp.value), sel.options[sel.options.length - 1]);
        }
        // Select the custom value if present
        if (inp.value) sel.value = inp.value; else sel.selectedIndex = 0;
        sel.focus();
      }
      // React to select choice
      sel.addEventListener('change', () => {
        if (sel.value === '__custom__') switchToInput();
      });
      // Input key helpers: Esc to go back to list
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          switchToSelect();
        }
      });
      // If user leaves input empty, revert to list
      inp.addEventListener('blur', () => {
        if (!inp.value) switchToSelect();
      });

      const a = document.createElement('div');
      a.className = 'cell amount';
      const aPrefix = document.createElement('span');
      aPrefix.className = 'prefix';
      aPrefix.textContent = 'PHP';
      const aVal = document.createElement('span');
      aVal.className = 'value';
      aVal.contentEditable = 'true';
      aVal.dataset.ph = '0.00';
      if (amt) aVal.textContent = amt;
      a.appendChild(aPrefix);
      a.appendChild(aVal);

      rowsEl.appendChild(d);
      rowsEl.appendChild(a);

      // Focus the description of the new row
      d.focus();
    }

    function removeLastRow() {
      // Each row has 2 cells appended sequentially
      if (rowsEl.children.length >= 2) {
        rowsEl.removeChild(rowsEl.lastElementChild);
        rowsEl.removeChild(rowsEl.lastElementChild);
      }
    }

    addBtn.addEventListener('click', () => addRow());
    removeBtn.addEventListener('click', () => removeLastRow());

    // Initialize date pickers to today if empty
    const payorDateEl = document.querySelector('.payor-date');
    const recvDateEl = document.querySelector('.recv-date');
    function setTodayIfEmpty(input) {
      if (!input) return;
      if (input.value) return;
      const d = new Date();
      // Convert to local yyyy-mm-dd
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      input.value = d.toISOString().slice(0, 10);
    }
    setTodayIfEmpty(payorDateEl);
    setTodayIfEmpty(recvDateEl);

    // Make the entire date field a hit box that opens the picker
    function enableFullHitDate(input) {
      if (!input) return;
      // Clicking anywhere should open the native picker
      input.addEventListener('click', (e) => {
        if (typeof input.showPicker === 'function') {
          input.showPicker();
        } else {
          // Fallback: focus, which still shows the picker on many browsers
          input.focus();
        }
      });
      // Enter key also opens the picker
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (typeof input.showPicker === 'function') input.showPicker();
        }
      });
    }
    enableFullHitDate(payorDateEl);
    enableFullHitDate(recvDateEl);

    // Make datalist show all options even when input has value
    function setupDescInput(input) {
      let prev = '';
      function openAll() {
        if (!input.list) return;
        prev = input.value;
        // clear to show all options; browser opens list on click/typing
        input.value = '';
        // put caret at start for clarity
        try { input.setSelectionRange(0, 0); } catch {}
      }
      input.addEventListener('focus', openAll);
      input.addEventListener('mousedown', () => {
        // running on mousedown ensures list opens before default filtering
        openAll();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') openAll();
      });
      input.addEventListener('blur', () => {
        // If user didn't choose anything and left it empty, restore previous
        if (!input.value && prev) input.value = prev;
      });
    }

    // Quarter mode: scale to 1/2 both dimensions (1/4 area) and arrange grid
    function applyQuarterMode(on) {
      document.documentElement.classList.toggle('quarter', on);
      if (on) {
        pagesWrap.style.gridTemplateColumns = '1fr 1fr';
      } else {
        pagesWrap.style.gridTemplateColumns = '1fr';
      }
    }
    quarterToggle.addEventListener('change', (e) => applyQuarterMode(e.target.checked));

    // Parse and format helpers
    function parseAmount(text) {
      if (!text) return 0;
      const cleaned = String(text)
        .replace(/[^0-9.,-]/g, '')
        .replace(/,(?=\d{3}(\D|$))/g, '')
        .replace(',', '.');
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    function formatNumber2(value) {
      const n = (typeof value === 'number') ? value : parseAmount(value);
      return n.toFixed(2);
    }

    function recalcTotal() {
      if (!autoTotal.checked) return; // respect manual mode
      let sum = 0;
      rowsEl.querySelectorAll('.cell.amount .value').forEach(el => {
        sum += parseAmount(el.textContent);
      });
      totalValueEl.textContent = formatNumber2(sum);
    }

    // Delegate input events to keep total updated and format on blur
    rowsEl.addEventListener('input', (e) => {
      if (e.target.classList && e.target.classList.contains('value')) {
        recalcTotal();
      }
    });
    rowsEl.addEventListener('blur', (e) => {
      if (e.target.classList && e.target.classList.contains('value')) {
        // Light formatting on blur; keep user's typing flow otherwise
        const val = parseAmount(e.target.textContent);
        if (!isNaN(val)) e.target.textContent = formatNumber2(val);
        recalcTotal();
      }
    }, true);

    // Mutation observer to handle add/remove actions
    const mo = new MutationObserver(() => recalcTotal());
    mo.observe(rowsEl, { childList: true, subtree: false });

    // Auto/manual toggle: lock editing when auto is on
    const totalValueEl = document.querySelector('#totalField .value');

    function applyAutoToggle() {
      const on = autoTotal.checked;
      totalValueEl.contentEditable = on ? 'false' : 'true';
      if (on) recalcTotal();
    }
    autoTotal.addEventListener('change', applyAutoToggle);

    // Build description options (dropdown)
    const descOptionsData = [
      'JIISA Org T-Shirt',
      '(Size: S-XL (No additional))',
      'Donation',
      'Membership Fee',
      'Merchandise',
      'Event Ticket',
      'Service Fee',
      'Miscellaneous'
    ];
    let dl = document.getElementById('descOptions');
    if (!dl) {
      dl = document.createElement('datalist');
      dl.id = 'descOptions';
      document.body.appendChild(dl);
    }
    dl.innerHTML = descOptionsData.map(t => `<option value="${t}"></option>`).join('');

    // seed with two lines similar to the sample
    addRow('JIISA Org T-Shirt', '255.00');
    addRow('(Size: S-XL (No additional))', '0.00');
    applyAutoToggle();

    // Now attach image export listener (after saveImagesBtn is declared)
    saveImagesBtn.addEventListener('click', async () => {
      const pages = Array.from(document.querySelectorAll('#pages .page'));
      let i = 1;
      for (const page of pages) {
        const content = page.querySelector('.content');
        if (content) await savePageAsImage(content, i++);
      }
    });

    // Add receipt (duplicates the current one for printing multiple per page)
    addReceiptBtn.addEventListener('click', () => {
      const first = pagesWrap.querySelector('.page');
      const clone = first.cloneNode(true);
      // Remove any dashed borders on editable placeholders in clone for a clean look
      // Note: cloned receipt won't be wired with dynamic JS; ideal for printing filled copies.
      pagesWrap.appendChild(clone);
      applyQuarterMode(quarterToggle.checked);
    });

    // Convenience: Ctrl+P focuses print
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        window.print();
      }
    });
  </script>
</body>
</html>
